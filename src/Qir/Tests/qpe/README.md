# Structure

I can walk you through all the steps during the Teams call with a screen share. Feel free to get in touch with me.

The `.\py_out.json` has been generated from 
[Quantum/samples/chemistry/IntegralData/Broombridge_v0.2/LiH_sto-3g.yaml](https://github.com/microsoft/Quantum/blob/main/samples/chemistry/IntegralData/Broombridge_v0.2/LiH_sto-3g.yaml)
with the following Python script
(in Anaconda env with installed `qsharp`)
```py
# From local clone of https://github.com/microsoft/Quantum/tree/main/samples/chemistry/IntegralData/
import json
from qsharp.chemistry import load_broombridge, load_input_state, encode
data = load_broombridge('./Broombridge_v0.2/LiH_sto-3g.yaml')
problem = data.problem_description[0]
input_state = load_input_state('./Broombridge_v0.2/LiH_sto-3g.yaml', problem.initial_state_suggestions[0]['Label'])
print(json.dumps(encode(problem.load_fermion_hamiltonian(), input_state)))
```

## If you need to regenerate the QIR
See https://github.com/cgranade/qpe-for-pnnl  

The `qsharp` folder from https://github.com/cgranade/qpe-for-pnnl has been copied to here and the work-around fixes were applied to `.\qsharp\Program.qs`.  
The `.\qsharp\est-energy.csproj` refers the version `0.24.39585-alpha`
(artifacts are [here](https://dev.azure.com/ms-quantum-public/Microsoft%20Quantum%20(public)/_build/results?buildId=39585&view=artifacts&pathAsName=false&type=publishedArtifacts), 
at `drop/drops/nugets`)
that has a [Q# compiler fix](https://github.com/microsoft/qsharp-compiler/pull/1373).
Or you can get the latest [Q# compiler](https://github.com/microsoft/qsharp-compiler), build it and use it.

The QIR is generated by `.\build.ps1`, the result is `.\qsharp\qir\est-energy.ll`.  

## If you don't need to or cannot regenerate the QIR
If you don't have the Q# comiler version `0.24.39585-alpha` then the generation of the `.\qsharp\qir\est-energy.ll` will fail, but a copy of it is available as `.\est-energy.ll`.
The compilation will continue.

## If you need to debug the QIR
The QAT tool, [this patch](https://github.com/qir-alliance/qat/pull/66), has been applied to `.\qsharp\qir\est-energy.ll`
in order to add the debugging information to the .ll file. The result is `.\est-energy.qat.dbginfo.ll`.

# Prerequisites
Run the `<Repo Root>\bootstrap.ps1` in the root dir of this repo. It builds the required native part of the QuantumSimulator, the QIR Runtime (and other things).
Or instead, you can set the env var `BUILD_CONFIGURATION` to `Release` and run the following scripts
* Native part of the QuantumSimulator
  * [Pre-requisites](https://github.com/microsoft/qsharp-runtime/blob/main/src/Simulation/Native/prerequisites.ps1).
  * [Build](https://github.com/microsoft/qsharp-runtime/blob/main/src/Simulation/Native/build-native-simulator.ps1).  
    If the build reports `<Repo Root>/.../Native/src/simulator/dbw_test.cpp:12:10: fatal error: 'omp.h' file not found` then feel free to ignore (it is a test) or install `libomp`.
    Just make sure that `<Repo Root>/src/Simulation/Native/build/libMicrosoft.Quantum.Simulator.Runtime.so` has been built.
* QIR Runtime
  * [Pre-requisites](https://github.com/microsoft/qsharp-runtime/blob/main/src/Qir/Runtime/prerequisites.ps1).
  * [Build](https://github.com/microsoft/qsharp-runtime/blob/main/src/Qir/Runtime/build-qir-runtime.ps1).

# Build 
`.\build.ps1`.  
The build result is in the `.\build` folder. If during the rebuild you hit unclear errors then remove the `.\build` folder and run `.\build.ps1` again.

# Run

`.\run.ps1`.  
Can take tens of minutes (or even a few hours) on a laptop to get the result.
In Linux/WSL the sanitizer may report runt-time issues in the native part of the QuantumSimulator. Feel free to ignore them for now.

# Debug

As has been mentioned above, in order to see the QIR function names in the debugger stack trace you need to apply The QAT tool, [this patch](https://github.com/qir-alliance/qat/pull/66).

## In Windows

We used the Visual Studio Code with the extension CodeLLDB (v1.7.0).  

<details><summary>The debuger configuration file "{Repo Root}/.vscode/launch.json":</summary>

```json
{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "name": "QPE", 
            "type": "lldb",
            "request": "launch",
            "cwd": "${workspaceFolder}\\src\\Qir\\Tests\\qpe", 
            "program": "${workspaceFolder}\\src\\Qir\\Tests\\qpe\\build\\qpe.exe",
            "args": ["py_out.json"],
            "environment": [
                { "name": "BUILD_CONFIGURATION", "value": "Debug" },  // Likely optional
                { "name": "PATH", "value": "../../Runtime/bin/Debug/bin;../../../Simulation/Native/build"}  // Likely optional
            ],
            "console":"integratedTerminal"
        },
    ]
}
```
</details>

## In Linux/WSL (Ubuntu 20.04)

Two options here.

### Command-line LLDB

```
lldb build/qpe py_out.json
(lldb) r
<Ctrl+c>
(lldb) bt
(lldb) f 1
(lldb) f 5
(lldb) q
```
### Visual Studio Code with the extension CodeLLDB (v1.7.0)
Make sure that you can run `./build/qpe py_out.json` in command line. For that you will likely need to adjust the `LD_LIBRARY_PATH` env var. 
```sh
export LD_LIBRARY_PATH=<absolute path to>/src/Qir/Tests/qpe/build:$LD_LIBRARY_PATH

# Make sure the var is set OK
env | grep LD_LIB

# Make sure all the lib paths are resolved correctly
ldd ./build/qpe

# Make sure the executable runs
./build/qpe py_out.json
```
Now start the VSCode.  

<details><summary>The debuger configuration file "{Repo Root}/.vscode/launch.json:":</summary>

```json
{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "type": "lldb",
            "request": "launch",
            "name": "QPE",
            "program": "${workspaceFolder}/src/Qir/Tests/qpe/build/qpe",
            "args": ["py_out.json"],
            "cwd": "${workspaceFolder}/src/Qir/Tests/qpe",
            //"environment": [
            //    { "name": "LD_LIBRARY_PATH", "value": "/mnt/c/ed/dev/QSharpCompiler/qsharp-runtime/qsharp-runtime_WSL/src/Qir/Tests/qpe/build" },
            //    { "name": "PATH", "value": "/mnt/c/ed/dev/QSharpCompiler/qsharp-runtime/qsharp-runtime_WSL/src/Qir/Tests/qpe/build"}
            //]
        }
    ]
}
```
</details>
